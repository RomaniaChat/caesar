<div id="irccloud_avatars" style="width:1px;height:1px;position:absolute;left:-1000px;"></div>
<script>
kiwi.plugin('irccloud-avatars', (kiwi) => {
    kiwi.on('irc.join', (event, net) => {
        kiwi.Vue.nextTick(() => {
            updateAvatar(net, event.nick);
        });
    });

    kiwi.on('irc.wholist', (event, net) => {
        const nicks = event.users.map((user) => user.nick);
        kiwi.Vue.nextTick(() => {
            nicks.forEach((nick) => {
                updateAvatar(net, nick);
            });
        });
    });

    function updateAvatar(net, nick) {
        const user = kiwi.state.getUser(net.id, nick);
        if (!user) {
            return;
        }

        if (user.avatar && user.avatar.small) {
            return;
        }

        const match = user.username.match(/^(?:uid|sid)([0-9]+)$/);
        if (!match) {
            return;
        }

        const scratch = document.querySelector('#irccloud_avatars');
        if (!scratch) {
            return;
        }

        const src = 'https://static.irccloud-cdn.com/avatar-redirect/' + match[1];
        const img = document.createElement('img');
        img.src = src;

        img.onload = function() {
            Object.assign(user.avatar, {
                small: src,
                large: '',
            });
            scratch.removeChild(img);
        };

        img.onerror = function() {
            scratch.removeChild(img);
        };

        scratch.appendChild(img);
    }
});
</script>
